# Лабораторная работа №4

---

- Выполнил: Кузьмин Артемий Андреевич
- Группа: P3214
- Преподаватьель: Пенской Александр Владимирович
- Вариант: `asm | acc | neum | hw | tick | binary | trap | mem | cstr | prob2 | cache`

## Содержание

- [Язык программирования](#Язык программирования)
  - [Синтаксис](#Синтаксис)

## Язык программирования

---

### Синтаксис:

``` ebnf
    program ::= data_section | code_section
    
    data_section ::= section_definition
                   | origin
                   | variable
                   | macro
                   | comment
                   
    section_definition ::= ".data" | ".code"

    origin ::= ".org" hex_number
    
    variable ::= label directive value
    
    label ::= <any symbols>:
    
    directive ::= ".word" | ".string"
    
    value ::= int_number | hex_number | "<any symbols>", 0 | label
    
    macro ::= "macro" <any symbols>
            | instruction
            | "endm"
              
    code_section ::= section_definition
                   | origin
                   | label
                   | instruction [ comment ]
                   | comment
                   
    instruction ::= opcode
                  | opcode operand
                  | opcode "[" operand "]"
                  | opcode "*[" operand "]"
                  | opcode operand "(pc)"
    
    opcode ::= "halt"
             | "cla"
             | "clc"
             | "clv"
             | "setc"
             | "setv"
             | "not"
             | "shl"
             | "shr"
             | "asr"
             | "cshl"
             | "cshr"
             | "iret"
             | "ei"
             | "di"
             | "jump"
             | "beqz"
             | "bneqz"
             | "ble"
             | "bgt"
             | "bcs"
             | "bcns"
             | "bvs"
             | "bvns"
             | "and"
             | "or"
             | "add"
             | "sub"
             | "mul"
             | "div"
             | "mod"
             | "load"
             | "save"
             | "setvec"
                  
    operand ::= int_number | hex_number | label
    
    int_number ::= ["-"] { <any of "0-9"> }
    
    hex_number :: "0x" { <any of "0-9a-f"> }
    
    comment ::= ; <any symbols>
```

### Семантика:

- **Инструкции:**
  - **halt** - остановка выполнения
  - **cla** - очистка аккумулятора
  - **clc** - очистка флага переноса
  - **clv** - очистка флага переполнения
  - **setc** - установка флага переноса
  - **setv** - установка флага переполнения
  - **not** - побитовое логическое отрицание значения в аккумуляторе
  - **shl** - логический сдвиг влево
  - **shr** - логическрй сдвиг вправо
  - **asr** - логический сдвиг вправо
  - **cshl** - циклический сдвиг влево
  - **cshr** - циклический сдвиг вправо
  - **iret** - возврат из прерывания
  - **ei** - разрешение прерываний
  - **di** - запрет прерываний
  - **jump addr** - безусловный переход по адресу
  - **beqz addr** - переход, если аккумулятор равен 0
  - **bneqz addr** - переход, если аккумулятор не равен 0
  - **ble addr** - переход, если аккумулятор меньше 0
  - **bgt addr** - переход, если аккумулятор больше либо равен 0
  - **bcs addr** - переход, если выставлен флаг переноса
  - **bcns addr** - переход, если не выставлен флаг переноса
  - **bvs addr** - переход, если выставлен флаг переполнения
  - **bvns addr** - переход, если не выставлен флаг переполнения
  - **and operand** - побитовое И со значением в аккумуляторе
  - **or operand** - побитовое ИЛИ со значением в аккумуляторе
  - **add operand** - сложение со значением в аккумуляторе
  - **sub operand** - вычесть значение из аккумулятора
  - **mul operand** - умножение со значением в аккумуляторе
  - **div operand** - целочисленное деление со значением в аккумуляторе
  - **mod operand** - остаток от деления аккумулятора на операнд
  - **load operand** - загрузить значение в аккумулятор
  - **save operand** - сохранить значение в память
  - **setvec operand** - установить обработчик прерываний
- **Стратегия вычислений:** Вызов по ссылке для прямой и косвенной адресаций. Строгие вычисления для прямой загрузки и смещений относительно PC
- **Область видимости:** Глобальная. Объявлять индетификатор можно как до, так и после места непосредственного использования
- **Типизация:** В явном виде отсутствует. Коректность типов проверяется только на этапе трансляции для объявленных констант
- **Виды литералов:**
  - Целочисленные: 10, -10, 0x10
  - Строковые: "hello", 0

## Организация памяти

---

Память команд и данных совмещенны. Размер машинного слова - 32 бита

### Типы адресации
- **Прямая загрузка** - в качестве операнда используется обозначенный в коде литерал. Пример:
`load 10 ; 10 -> acc`
- **Абсолютная адресация** - литерал воспринимается как ссылка на ячейку, в которой находится операнд. Пример: `load [10] ; mem[10] -> acc`
- **Косвенная адресация** - литерал воспринимается как ссылка на ячейку, в которой находится ссылка на операнд. Пример:
`load *[10] ; mem[mem[10]] -> acc`
- **Со смещением относительно PC** - литерал обозначает сдвиг PC. Операнд вычисляется как (PC + литерал). Пример:
`jump -1(pc) ; переход на предыдущую инструкцию`

### Отображение программы и данных на процессор

Если не обазначена деректива `.org`, то все данные и инструкции будут записываться последовательно начиная с первой ячейки. 

Общие правила:
- Одна инструкция - одна ячейка
- Одна `.word` константа - одна ячейка
- Одна `.string` константа - одна ячейка для каждого символа, в том числе для ноль терминатора

### Регистры
- **ACC** - 32 разрядный аккумулятор. Используется для формирования результата, вывода данных, а также некоторых для некоторых перехода
- **ADDR** - 24 разрядный адресный регистр. Используется при обращении к памяти. Именно в этот регистр будут записаны литералы при выполнении команд с прямой или косвенной адресацией
- **RET_ADDR** - 24 разрядный регистр адреса возврата. В этот регистр сохраняется PC при переходе на обработку прерывания.
- **PC** - 24 разрядный регистр, указывающий на адрес следующей исполняемой инструкции. При переходе литералы будут записаны в этот регистр.

## Система команд

---

### Особенности процессора:

- Цикл выполнения одной комманды состоит из следующих этапов:
  - **Command Fetch (CF)** - чтение инструкции по адресу PC. Потом PC увеличивается на 1
  - **Address Fetch (AF)** - чтение адреса операнда из памяти по адресу аргумента из инструкции. Данный этап выполнения команды будет присутствовать тольлко при косвенной адресации
  - **Operand Fetch (OP)** - чтение операнда для инструкции из памяти по адресу, полученному либо из AF, либо аргумента из инструкции. Данный этап отсутствует у команд без операнда, команд ветвления, а также при прямой загрузке операнда
  - **Execution (EX)** - исполнение инструкции
  - **Interruption (INT)** - обработка прерывания
- Этап обработки прерывания будет пропущен, если прерывания запрещены или не поступал соответствующий сигнал. Переход на обработку прерывания также не произойдет, если сигнал поступил во время обработки другого прерывания
- Переход на прерывание **не сохраняет** значение ACC и флагов состояния. Работа по сохранинию ACC подает на программиста при реализации обработчика прерывания
- Используется Memory-Mapped IO - ввод/вывод осуществляется через специальные ячейки памяти при помощи команд `load` и `save` соответственно

### Набор инструкций

| Язык               | Инструкция   | Кол-во тактов | Описание                                                    |
|:-------------------|:-------------|:--------------|:------------------------------------------------------------|
| `halt`             | HALT         | 2             | Останов                                                     |
| `cla`              | CLA          | 2             | уменьшить значение в текущей ячейке на 1                    |
| `clc`              | left         | 1             | перейти к предыдущей ячейке                                 |
| `clv`              | right        | 1             | перейти к следующей ячейке                                  |
| `setc`             | print        | 2             | напечатать значение из текущей ячейки (символ)              |
| `setv`             | input        | 2             | ввести извне значение и сохранить в текущей ячейке (символ) |
| `not`              | jmp `<addr>` | 1             | безусловный переход                                         |
| `shl`              | jz `<addr>`  | 2             | переход, если в текущей ячейке 0                            |
| `shr`              | halt         | 0             | остановка                                                   |
| `asr`              | halt         | 0             | остановка                                                   |
| `cshl`             | halt         | 0             | остановка                                                   |
| `cshr`             | halt         | 0             | остановка                                                   |
| `iret`             | halt         | 0             | остановка                                                   |
| `ei`               | halt         | 0             | остановка                                                   |
| `di`               | halt         | 0             | остановка                                                   |
| `jump <operand>`   | halt         | 0             | остановка                                                   |
| `beqz <operand>`   | halt         | 0             | остановка                                                   |
| `bneqz <operand>`  | halt         | 0             | остановка                                                   |
| `ble <operand>`    | halt         | 0             | остановка                                                   |
| `bgt <operand>`    | halt         | 0             | остановка                                                   |
| `bcs <operand>`    | halt         | 0             | остановка                                                   |
| `bcns <operand>`   | halt         | 0             | остановка                                                   |
| `bvs <operand>`    | halt         | 0             | остановка                                                   |
| `bvns <operand>`   | halt         | 0             | остановка                                                   |
| `and <operand>`    | halt         | 0             | остановка                                                   |
| `or <operand>`     | halt         | 0             | остановка                                                   |
| `add <operand>`    | halt         | 0             | остановка                                                   |
| `sub <operand>`    | halt         | 0             | остановка                                                   |
| `mul <operand>`    | halt         | 0             | остановка                                                   |
| `div <operand>`    | halt         | 0             | остановка                                                   |
| `mod <operand>`    | halt         | 0             | остановка                                                   |
| `load <operand>`   | halt         | 0             | остановка                                                   |
| `save <operand>`   | halt         | 0             | остановка                                                   |
| `setvec <operand>` | halt         | 0             | остановка                                                   |
